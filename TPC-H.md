# Example: NoLAP for TPC-H
The TPC Benchmark H (TPC-H) is a well-known and widely used decision support benchmark. It consists of a number of queries along with the data used to populate a database. We have taken some data generated by the TPC-H data generator (which is provided as a set of tables) and transformed it into the NoLAP multidimensional schema storing the data in a MongoDB database. The goal is purely educational to demonstrate how such a database could look like and what kind of reports and queries can be executed using JSONiq and the 28.io platform.

## Generic mapping from a SQL table to a hypercube
In order to convert the TPC benchmark data in a generic way (reproducible with other SQL tables), we associated each SQL table to a NoLAP static hypercube:
- Customers
- Suppliers
- SuppParts
- Orders
- LineItems
- (For the sake of simplicity, we excluded nations and regions that were inlined in customers and suppliers)

Then, for each table, the primary keys were converted to dimensions, and the other SQL attributes were converted to reportable concepts (primary items).

For example, consider the schema of the PARTSUPP table:

    PS_PARTKEY (primary)
    PS_SUPPKEY (primary)
    PS_AVAILQTY
    PS_SUPPLYCOST
    PS_COMMENT

This table can be mapped to a dimension-2 hypercube (dimensions: tpch:PartKey, tpch:SuppKey and the always present xbrl:Concept). Three concepts can be used: tpch:SupplierPartAvailableQuantity, tpch:SupplierPartSupplyCost, tpch:SupplierPartComment.

In XBRL, there are dimensions that are not technically required by NoLAP, but that are commonly there on a semantic level: xbrl:Entity, xbrl:Period and xbrl:Unit. In this case, tpch:SuppKey can be renamed to xbrl:Entity because a supplier can be considered an XBRL entity. xbrl:Period can be set with a dummy value ("forever"), and xbrl:Unit set according to the original SQL schema types. We are doing this because our implementation natively supports these four common xbrl: fields, but the only one that is important to the NoLAP mapping is xbrl:Concept.

Concretely, the following row (represented as flat JSON)

    {
      "PS_SUPPKEY" : "Supplier#000010000", 
      "PS_PARTKEY" : 1, 
      "PS_SUPPLYCOST" : 984.93, 
      "PS_AVAILQTY" : 1807, 
      "PS_COMMENT" : "egular requests sleep quickly across the regular theodolites. ironic ideas affix regular pains. blithely re"
    }

can be mapped to the following facts:

    {
     Aspects: {
        "xbrl:Concept": "tpch:SupplierPartAvailableQuantity",
        "xbrl:Entity": "Supplier#0000100000",
        "xbrl:Period": "forever",
        "xbrl:Unit": "Numeric",
        "tpch:PartKey": 1
      },
      Value: 1807
    }
    {
      Aspects: {
        "xbrl:Concept": "tpch:SupplierPartSupplyCost",
        "xbrl:Entity": "Supplier#0000100000",
        "xbrl:Period": "forever",
        "xbrl:Unit": "USD",
        "tpch:PartKey": 1
      },
      Value: 984.93
    }
    {
      Aspects: {
        "xbrl:Concept": "tpch:SupplierPartComment",
        "xbrl:Entity": "Supplier#0000100000",
        "xbrl:Period": "forever",
        "tpch:PartKey": 1
      },
      Value: "egular requests sleep quickly across the regular theodolites. ironic ideas affix regular pains. blithely re"
    }

## Queries

1. Return a fact table by filtering the set of customers. This should show that we can build a user-defined hypercube

2. Execute one of the TPC-H queries efficiently. This should show that it’s possible and how. Ideally with a nice looking and easy to understand query

http://tpchd.xbrl.io/html/query.jq?id=Q1

http://tpchd.xbrl.io/html/query.jq?id=Q3

http://tpchd.xbrl.io/html/query.jq?id=Q9

## Spreadsheet-like Reports
1. Create a report (ideally html) for all orders (including nested line items) for a particular set of customers. This should show that we can create a spreadsheet like experience with reports that “live” in the database.
2. Create a report that contains computations. For example, aprofit report for a particular customer
- Revenue = l_extendedprice * (1-l_discount)  (see Query Q3)
- Profit = Revenue - (ps_supplycost*l_quantity) (see Query Q9)
This should show that we can compute computations in the database (specified by the business user) that would otherwise be done in the spreadsheet.
